---
title: 协程技术与总结
comments: true
mathjax: true
tags:
  - Linux
  - Windows
  - C++ 开发
categories:
  - C/C++ 多线程编程精髓
date: 2021-10-18 15:03:27
---
#### 音乐小港
{% meting "1406049989" "netease" "song" "theme:#555" "mutex:true" "listmaxheight:340px" "preload:auto" %}

---
# 协程技术与总结
## 协程

我们知道，线程是操作系统的内核对象，多线程编程时，如果线程数过多，就会导致频繁的上下文切换，这些对性能是一种额外的损耗。例如，在一些高并发的网络服务器编程中，使用一个线程服务一个 socket 连接是很不明智的，因此现在的主流做法是利用操作系统提供了基于事件模式的异步编程模型，用少量的线程来服务大量的网络连接和 IO。但是采用异步和基于事件的编程模型，让程序代码变得复杂，非常容易出错，也提高排查错误的难度。

协程，是在应用层模拟的线程，它避免了上下文切换的额外损耗，同时又兼顾了多线程的优点，简化了高并发程序的复杂度。还是以上面高并发的网络服务器为例，可以为每一个 socket 连接使用一个协程来处理，在兼顾性能的情况下，代码也清晰。

协程是在1963 年由 Melvin E. Conway USAF, Bedford, MA 等人提出的一个概念，且协程的概念是早于线程提出的。但是由于协程是非抢占式的调度，无法实现公平的任务调用，也无法直接利用多核 CPU 的优势，因此，我们不能武断地说协程是比线程更高级的技术。尽管协程的概念早于线程提出，但是目前主流的操作系统原生 API 并不支持协程技术，新兴的一些高级编程语言如 Golang 都是在语言的运行时环境中自己利用线程技术模拟了一套协程。

这些语言协程的内部实现上都是是基于线程的，思路是维护了一组数据结构和 n 个线程，真正的执行还是线程，协程执行的代码被扔进一个待执行队列中，由这 n 个线程从队列中拉出来执行。这就解决了协程的执行问题。那么协程是怎么切换的呢？

以 Golang 为例，Golang 对操作系统的各种 IO 函数（如 Linux 的 epoll、select，Windows 的 IOCP 等）进行了封装，这些封装的函数提供给应用程序使用，而其内部调用了操作系统的异步 IO 函数，当这些异步函数返回 busy 或 blocking 时，Golang 利用这个时机将现有的执行序列压栈，让线程去拉另外一个协程的代码来执行。

由于 Golang 是从编译器和语言基础库多个层面对协程做了实现，因而，Golang 的协程是目前各类存在协程概念的语言中实现的最完整和成熟的，十万个协程同时运行也毫无压力。带来的优势就是，程序员可以在编写 Golang 代码的时候，可以更多的关注业务逻辑的实现，更少的在这些关键的基础构件上耗费太多精力。

现今之所以协程技术这么流行是因为大多数设计喜欢使用异步编程以追求程序的性能，这就强行的将线性的程序逻辑打乱，程序逻辑变得非常的混乱与复杂。对程序状态的管理也变得异常困难，例如 NodeJS 那恶心的层层 Callback。在我们疯狂被 NodeJS 的层层回调恶心到的时候，Golang 作为名门之后开始进入广大开发者的视野，并且迅速的在 Web 后端攻城略地。例如，以 Docker 以及围绕 Docker 展开的整个容器生态圈为代表，其最大的卖点就是协程技术，至此协程技术开始真正的流行与被讨论起来。

[腾讯公司开源了一套 C/C++ 版本的协程库 libco](https://github.com/Tencent/libco)，有兴趣的读者可以研究一下其实现原理。

因此，协程技术从来不是什么新东西，只是人们为了从重复复杂的底层技术中解脱出来，能够快速专注业务开发而带来的产物。万变不离其宗，只要我们掌握了多线程编程的技术的核心原理，我们也能快速的学习协程技术。

## 课程总结
至此，本课程也就全部结束了。在整个课程中介绍了目前主流的 C/C++ 开发环境下的两个操作系统 Windows 和 Linux 系统层面上的线程原理和多线程资源同步技术的方方面面，同时基于这些基础知识延伸出了更高级的线程池技术和队列系统，也介绍了目前前沿的协程技术。

无论某种编程语言和其运行时环境（如 Java、Python）对操作系统的线程功能增加了多少中间层、封装了多少功能的，操作线程提供的线程相关 API 和同步接口是最基础的，且由于这些接口是操作系统提供的，它们在相当长的时间内都会基本保持不变，一旦你理解并熟练使用它们，你不仅可以灵活地学习和开发出强大的多线程程序来，同时也能快速地理解其他语言中的各种线程同步概念和技术。

多线程编程技术是怎么强调也不过份基本功，希望读者能够非常熟练地掌握它们，这种熟练掌握不仅是理解其原理，一定是熟悉到具体的 API 层面来上。



---
[点击这里下载课程源代码](https://github.com/balloonwj/gitchat_cppmultithreadprogramming)

来源:[范蠡《C/C++ 多线程编程精髓》](https://gitbook.cn/gitchat/column/5d11e726820bf61799b8277f)